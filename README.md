
代码行数统计：
2022.4.21   15,588
2022.4.26   17,363
2022.4.28   17,886
2022.5.3     17,909
2022.5.4     18,452
2022.5.5     18,532
2022.5.10   18,564
2022.5.11   19,384
2022.5.12   24,346
2022.5.16   41,796（虚高）



2022.4.28 
准备测试    在/home/workspace/Files/gpu-ray-traversal目录下，test_scene下准备8条光线和BVH的数据进行第一次测试

2022.5.4  
初步测试，早晨完成了光线与BVH的相交测试调试
下午对栈的管理进行调试

2022.5.5
对整条光线的遍历进行了测试，计算的结果正确，但是还有两个待解决的问题
1.pop_1 pop_2 pop_3的问题，也即返回的信号位
2.读数据的问题，整个系统一直在遍历，没有停止，需要好好查看一下


2022.5.10 
修改了两处bug，1.调度单元有可能会丢掉一组数据；2.弹栈的使能。

2022.5.11
又想到一处错误，也即一条光线的真正遍历完成标记并不是栈为空即可，而是栈空了之后再去pop
另外，又找到一处错误，即hitT丢失

2022.5.17
又发现一处错误，即光线的新发射的光线，需要向空栈再发送一次弹栈的请求。这是栈是空的，需要再设置一个标记为来标记不可填充，否则会出错，导致栈的利用率不高。
修改记录（25 stacks）：
（修改前）88M
（修改后）134M

后续尝试增加栈的数目来提升性能，先增加10个，要注意代码的正确性
修改记录（35 stacks）:
（修改前） 192M     
（修改后）712M，基本上符合预期值，但是还是有一些栈没有用起来，同时，内存访问的延迟没有考虑，黄老师建议看一看RD-smi

需要改一下光线的位宽，因为32位最大表示范围为4294967295！草。够用

2022.5.18
尝试将场景遍历完全，即将整个场景都遍历完毕，用200w条光线（可能需要跑很久），发现场景的复杂度会影响到遍历的效率，大概下降到550M左右。另外发现一个严重的Bug，dispatch的使能位的控制信号不是同一时钟，有可能发生无法继续遍历的情况，现已修改。
栈的个数只有在BVH比较复杂的时候才会进入。   
另外，又寻找了一个思路，也即《Efficient Single-Precision Floating-Point Division Using Harmonized Parabolic Synthesis》论文中的流水和非流水的浮点除法设计思路，可以考虑将该设计移植到本设计中，同时还存在一个近似计算的概念。

实验做到现在考虑将更多的场景来进行测试验证，首先将AO、Diffuse状态下的Conference场景取出来准备使用测试。存储的地址为/home/workspace/Files/gpu-ray-traversal/test_scene/conference_AO_H和/home/workspace/Files/gpu-ray-traversal/test_scene/conference_Diffuse_H
找郭老师咨询了一下性能测试的结果，发现不对，决定手鲁一下代码，新建一个Github传上去备用

2022.5.19
今天花了较多的时间来修改浮点除法的问题，现已改成3个周期
首次测试约114M，有较多的空闲的栈，考虑更换调度算法。换了之后98M

2022.5.20
为了在系统性能不是特别满足的条件下考虑论文的事情，考虑将自己设计的硬件统计一下计算逻辑\
| 名称   | FADD_MUL   | FADD   |  FMUL   |  FCMP   |  FDIV   |
| -------- | -------- | -------- | -------- | -------- | -------- |
|toal |    17  | 13 |    16  |  26   |   1   |
|Traverse |    12   |0 |  0  |    21  |   0    |  
| IST0 |   1    |4 |    5  |     0 |  0    |
| SU   |   0    |0 |    0  |     0 |  1    |
| IST1   |   0    |0 |    1  |    2 |  0    |
| IST2   |   2    |4 |    5  |    1 |  0    |
| IST3   |   2    |5 |    5  |     2 |  0    |
| T & I   |          |86 |92 |108 |0 |




2022.5.25
1.准备修改一下跳出for循环条件，也即预取一下下一次三角形id的v00.x，这样应该可以获得一定的性能提升

记录一下各个场景的数据

| 场景名称   | 使用参数   | 光线数量   |   内部节点数量   |   三角形个数   |  2060性能   | 2080Ti性能 |
| -------- | -------- | -------- | -------- | -------- | -------- | -------- |
|conference |    1  | 2073600 |    105025  |   350949   |   342.29M   |  949.49M |
|fairyforest |    5   |2073600 |  57912    |    186602  |   324.29M    |  1012.10 M   |
|sibenik |   5    |2073600 |    30212  |     96818 |  308.03M    |   990.48 M  |
|sanmiguel |    3   |2073600 |   3421602   |   11700697   |  154.51M     | 339.03 M   |

2.发现两处Bug:
(1)Traverse的部件有一处逻辑写错，也就是两个都相交时，判断节点正负有误，所以会有数据无法弹出的情况
(2)部分结果错误，这个好像问题不大，因为多次命中，会有多个结果
为了后续验证过程中可以快速寻找中间变量，这里将Intersection部分的中间变量记录下来。
IST0   Oz
SU      invDz
IST1    t
IST2    u Ox Dx
IST3    hit  Oy  Dy   v

2022.5.26调试记录
性能记录：发现调整后的流水线在图像初段稳定在112M，在图像中段，稳定在80M

1.发现三角形准备的太慢，导致Intersection部分的流水线有许多空拍
具体优化思路：(1)换一个场景试一试，找一个三角形节点较少的试试;(2)加Traverse部件。
2.今日至少完成计划：(1)调试成可以运行其他光线类型的，即加入tmin;(2)根据性能情况考虑是否加Traverse;(3)准备好所有的光线

性能：
primary:
conference: 110.92
fairyforest:   55.01

2022.6.6 调试记录
发现前期使用1GHz的频率综合不下来，所以考虑将关键路径的逻辑进行修改，首先将浮点乘加单元进行综合尝试。